<!DOCTYPE html>
<html>
<head>
	<title>test000304</title>
	<meta charset="utf-8">
</head>
<body>
	<video autoplay="true" style="border: 1px solid black;" width="496px" height="372px"></video>
	<a></a>
	<br>Temps entre images : <input type="text" id="dt" value="1000"/>
	<br>FPS du timelapse : <input type="text" id="fps" value="10">
	<br>Largeur : <input type="text" id="resW" value="1920">
	<br>Hauteur : <input type="text" id="resH" value="1080">
	<br>Température : <input type="text" id="colorTemp" value="10000">
	<br><input type="button" id="timelapsePic" onclick="timelapse()" value="Timelapse Début"></input>
	<input type="button" id="timelapsePic" onclick="timelapseEnd()" value="Timelapse Fin"></input>
	<script src="whammy.js"></script>
	<script>
	const video = document.getElementsByTagName("video")[0];
	const canvas = document.createElement("canvas");
	const ctx = canvas.getContext("2d");
	var imageCapture;
	
	var constraints;
	var colorTemp;
	
	var intervalID;
	var dt;
	
	var encoder;

	function onCapabilitiesReady(capabilities) {
    	if (capabilities.torch) {
      		track.applyConstraints({
      			advanced: [{
      				colorTemperature: {min: 6000, ideal: 7000}
      			}]
      		})
      	.catch(e => alert(e));
    	}
  	}

	function streaming() {
		navigator.mediaDevices.getUserMedia({
			video: {
				facingMode: "environment",
				width: resW,
				height: resH,
			}
		})
		.then((stream) => {
			video.srcObject = stream;
			const track = stream.getVideoTracks()[0];
			video.addEventListener('loadedmetadata', (e) => {  
    		window.setTimeout(() => (
      			onCapabilitiesReady(track.getCapabilities())
    			), 500);
 	 		});

			track.applyConstraints(constraints);
			imageCapture = new ImageCapture(track);
		})
		.catch((err) => {
	  		alert(err);
	  		timelapseEnd();
		});
	}

	function timelapse() {
		fps = document.getElementById("fps").value;
		dt = document.getElementById("dt").value;
		colorTemp = document.getElementById("colorTemp").value;
		
		canvas.width = document.getElementById("resW").value;
		canvas.height = document.getElementById("resH").value;
		
		streaming();

		encoder = new Whammy.Video(fps);
		intervalID = setInterval(function() {
			ctx.drawImage(video, 0, 0, canvas.width, canvas.height);	
			encoder.add(canvas);
		}, dt);
	}

	function timelapseEnd() {
		clearInterval(intervalID);
		try {
			var output = encoder.compile();
			var url = URL.createObjectURL(output);
			document.getElementsByTagName("a")[0].href = url;
			document.getElementsByTagName("a")[0].download = "file.webm";
			document.getElementsByTagName("a")[0].innerText = "Télécharger la vidéo.";
		}
		catch (e) {
			alert(e);
		}
	}
</script>
</html>