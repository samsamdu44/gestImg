<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	<meta charset="utf-8">
</head>
<body>
	<video autoplay="true" style="border: 1px solid black;" width="496px" height="372px"></video>
	<a></a>
<!--	<input type="button" id="buttonPic" onclick="takePic()" value="Prendre une photo"></input>-->
	<br>Temps entre images : <input type="text" id="dt" value="1000"/>
	<br>FPS du timelapse : <input type="text" id="fps" value="10">
	<br>Largeur : <input type="text" id="resW" value="1920">
	<br>Hauteur : <input type="text" id="resH" value="1080">
	<br>Température : <input type="text" id="colorTemp" value="10000">
	<br><input type="button" id="timelapsePic" onclick="timelapse()" value="Timelapse Début"></input>
	<input type="button" id="timelapsePic" onclick="timelapseEnd()" value="Timelapse Fin"></input>
	<script src="whammy.js"></script>
	<script>
	var canvas = document.createElement("canvas");
	var resW; //max=3968px
	var resH; //max=2976px
	let colorTemp;
	var intervalID;
	var dt;
	var constraints;
	var encoder;
	var video = document.getElementsByTagName("video")[0];
	alert(navigator.mediaDevices.getSupportedConstraints().colorTemperature);


	function streaming() {
		navigator.mediaDevices.getUserMedia(constraints)
			.then(function(stream) {
			video.srcObject = stream;
		})
			.catch(function(err) {
	  		alert(err);
		});
	}
/*
	function takePic() {
		var ctx = canvas.getContext("2d");
		ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
		var dataURI = canvas.toDataURL("image/jpeg");
		document.getElementsByTagName("a")[0].href = dataURI;
		document.getElementsByTagName("a")[0].download = "image.jpeg";
		document.getElementsByTagName("a")[0].innerText = "Télécharger l'image";
	}
*/
	function timelapse() {
		fps = document.getElementById("fps").value;
		dt = document.getElementById("dt").value;
		resW = document.getElementById("resW").value;
		resH = document.getElementById("resH").value;
		colorTemp = document.getElementById("colorTemp").value;
		constraints = {
			audio: false,
			video: {
				facingMode: {exact: "environment" },
				width: resW,
				height: resH
			}
		};
		canvas.width = resW;
		canvas.height = resH;
		streaming();
		encoder = new Whammy.Video(fps);
		var ctx = canvas.getContext("2d");
		intervalID = setInterval(function() {
			ctx.drawImage(video, 0, 0, canvas.width, canvas.height);	
			encoder.add(canvas);
		}, dt);
	}

	function timelapseEnd() {
		clearInterval(intervalID);
		try {
			var output = encoder.compile();
			var url = URL.createObjectURL(output);
			document.getElementsByTagName("a")[0].href = url;
			document.getElementsByTagName("a")[0].download = "file.webm";
			document.getElementsByTagName("a")[0].innerText = "Télécharger la vidéo.";
		}
		catch (e) {
			alert(e);
		}
	}
</script>
</html>